## 도메인 이벤트와 전술적 설계

- 도메인 이벤트란

  - 바운디드 컨텍스트 내의 비즈니스 관점에서 중요한 사항들에 대한 기록

    

  - 도메인 이벤트가 전략적 설계를 위해 매우 중요한 도구

    

  - 인과관계가 적절하게 맺어지지 않으면,  전체 도메인 상황이 잘못되거나 혼란스러워 질 수 있음

    - 도메인 이벤트의 생성과 활용을 통해 손쉽게 달성 가능

<br>

***

### 도메인 이벤트를 설계, 구현 사용하기

- 도메인 이벤트를 효과적으로 설계하고 구현해 보자.

  - 도메인 이벤트 형태는 일반적으로 도메인 이벤트가 발생할 때 그 날짜와 시간을 전달하길 원하므로, 최소한의 인터페이스를 고려하여 설계를 시작하게 된다.

  ```kotlin
  public interface DomainEvent{
    public Date OccuredDate;
    
    public Date getoccuredDate() {
      ...
      return this.OcuuredDate
    }
  }
  ```

  

  - 도메인 이벤트에 어떻게 이름을 붙일 것인지에 대해 세심한 주의를 기울 여야 한다.

    - 도메인 모델의 보편언어를 반영해야 한다. 도메인 모델 안에서 발생하는 사건과 모델 밖을 이어주는 다리를 형성하고, 이벤트를 통해 모델들이 원활히 의사소통하는 데 필수적인 역할을 한다

      - 도메인 이벤트 타입을 나타내는 이름은 과거에 발생한 것을 서술하는데, 과거형 동사로 표현할 수 있다. ( ProductCreated, ReleaseScheduled, SprintScheduled, BacklogItemPlanned... )

      

  - 도메인 모델에서 발생한 사건의 기록을 온전히 전달하려면 도메인 이벤트 이름과 프로퍼티가 모두 필요하다. 도메인 이벤트는 어떤 프로퍼티를 담고 있어야 할까

    - 각 프로퍼티들은 도메인 식별자 및 생성에 있어 필수적인 것들을 들고 있어야 한다. ( productId, productName, product Description 
    - 이벤트를 발생시키는 경우에는 이벤트가 만들어지는 시점에, 명령이 제공하는 모든 프로퍼티들을 담고 있어야 한다.

    

  - 도메인 이벤트에 그 의미를 잃을 정도로 너무 많은 데이터를 가득 채우는 일은 없어야 한다.

    - 소비자가 요소들에 대해 깊이 이해하지 못한다면, 모든 추가 데이터는 오히려 정확하게 이해하기 어렵게 만든다.

      

  - 수정된  애그리게잇과 도메인 이벤트가 같은 트랜잭션에서 함께 저장될 필요가 있다.

    - 애그리게잇을 하나의 테이블에 그리고 도메인 이벤트를 이벤트 리포지터리 테이블에 저장하고 난 후, 트랜잭션을  설정할 수 있다.

    - 도메인 이벤트를 이벤트 리포지터리에 유지하는 것은 도메인 모델 간에 발생한 것에 대한 인과관계의 순서를 지속시켜 준다.

      

  - 도메인 이벤트가 이벤트 리포지터리에 한 번 저장되면, 이벤트에 관심 있는 어떤 대상에게든지 전달될 수 있다.

    - 다만, 도메인 이벤트를 인과관계의 순서에 따라 저장하는 것이 같은 요청 내에 분산되어 있는 다른 노드들에 도달할 것은 보장하는 것은 아니다.

      - 이에 따른 적절한 인과관계를 파악하고 소비하는 것은 바운디드 컨텍스트가 가져야 할 책임이다.

        

    - 도메인 이벤트 그 자체가 인과관계를 나타내거나 시퀀스나 인과관계 식별자처럼 도메인 이벤트와 관계된 메타데이터 형태가 인과관계를 나타낼 수도 있다.

    

    

  - 누가 이벤트를 발생시키는지에 대해서도 주목할 필요가 있다.   

    - 보통은 이벤트를 발생시키는 사용자 인터페이스에 의해 발현되는 사용자 기반 명령인 경우가 많지만, 떄로는 다른 원인으로 도메인 이벤트가 발생될 수도 있다.
      - 마지막 영업일, 시간 만료에 의한 이벤트 발생



***

### 이벤트 소싱

<img width="703" alt="MSA3 19" src="https://user-images.githubusercontent.com/50399804/127140777-14e6a855-46a0-4010-804f-29cd6843ce7b.png">

- 애그리게잇 인스턴스에 대해 변경된 것에 대한 기록으로, 발생했던 모든 도메인 이벤트를 저장하는 것을 말한다.

  

- 애그리게잇 상태 전체를 저장하는 대신, 발생했던 각 도메인 이벤트 모두를 저장한다.

  

- 어떤 사유로 인해 메모리에서 삭제됐던 애그리게잇들을 이벤트 스트림을 통해 온전히 환원시킬 수 있다.

  

- 핵심 도메인에서 계속 발생하는 모든 기록을 개별적인 발생 수준으로 저장하고 있으므로 법적 기준에 대한 준수 및 분석과 같은 것들이 도움되는것 뿐만 아니라 소프트웨어 개발자가 소스 코드를 디버깅하거나 이벤트 사용 추세를 조사할 때, 이벤트 스트림을 사용해볼 수도 있다.

